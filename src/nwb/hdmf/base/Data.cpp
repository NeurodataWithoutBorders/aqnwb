#include "nwb/hdmf/base/Data.hpp"

using namespace AQNWB::NWB;

// Register the base Data class
REGISTER_SUBCLASS_IMPL(Data)

/** Constructor */
Data::Data(const std::string& path, std::shared_ptr<AQNWB::IO::BaseIO> io)
    : RegisteredType(path, io)
{
}

Status Data::initialize(const IO::BaseArrayDataSetConfig& dataConfig)
{
  auto ioPtr = getIO();
  if (ioPtr == nullptr) {
    std::cerr << "IO object has been deleted. Can't initialize Data: " << m_path
              << std::endl;
    return Status::Failure;
  }
  
  // Create the dataset or link
  auto dataset = ioPtr->createArrayDataSet(dataConfig, this->m_path);
  
  // Check if this is a link configuration
  const IO::LinkArrayDataSetConfig* linkConfig =
      dynamic_cast<const IO::LinkArrayDataSetConfig*>(&dataConfig);
  
  if (linkConfig != nullptr) {
    // For link configs, createArrayDataSet returns nullptr by design
    // Verify the link target exists
    if (!ioPtr->objectExists(linkConfig->getTargetPath())) {
      std::cerr << "Data::initialize: Link target does not exist: "
                << linkConfig->getTargetPath() << std::endl;
      return Status::Failure;
    }
    // Link creation succeeded
  } else {
    // For non-link configs, nullptr indicates failure
    if (dataset == nullptr) {
      std::cerr << "Data::initialize: Failed to create dataset: " << m_path
                << std::endl;
      return Status::Failure;
    }
  }
  
  // setup common attributes
  Status commonAttrsStatus = ioPtr->createCommonNWBAttributes(
      m_path, this->getNamespace(), this->getTypeName());
  return commonAttrsStatus;
}

namespace AQNWB::NWB
{

// Explicitly instantiate the DataTyped template for all common data types.
// This ensures that these specializations are generated by the compiler,
// reducing compile times and ensuring availability throughout the program.
template class DataTyped<std::any>;
template class DataTyped<uint8_t>;
template class DataTyped<uint16_t>;
template class DataTyped<uint32_t>;
template class DataTyped<uint64_t>;
template class DataTyped<int8_t>;
template class DataTyped<int16_t>;
template class DataTyped<int32_t>;
template class DataTyped<int64_t>;
template class DataTyped<float>;
template class DataTyped<double>;
template class DataTyped<std::string>;
}  // namespace AQNWB::NWB
